name: Build & Upload Cross-Platform Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (example: v1.0.0)"
        required: true
        default: "v1.0.0"
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: win
            cmd: npx electron-builder --win --x64 --publish never
          - os: windows-latest
            target: win32
            cmd: npx electron-builder --win --ia32 --publish never
          - os: ubuntu-latest
            target: linux
            cmd: npx electron-builder --linux AppImage --publish never
          - os: macos-latest
            target: mac
            cmd: npx electron-builder --mac --publish never

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build (${{ matrix.target }})
        run: ${{ matrix.cmd }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Normalize artifact names + checksums
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const crypto = require('crypto');
          const pkg = require('./package.json');

          const v = pkg.version;
          const t = String(process.env.TARGET || '').toLowerCase();
          const dist = 'dist';
          const out = path.join(dist, 'release-assets');
          fs.mkdirSync(out, { recursive: true });

          const isWin = t === 'win' || t === 'win32';
          const exts = isWin
            ? ['.exe']
            : (t === 'linux' ? ['.AppImage'] : ['.dmg', '.zip']);

          const osTag = isWin ? 'windows' : (t === 'linux' ? 'linux' : 'macos');
          const archTag = t === 'win32' ? 'x86' : 'x64';

          const files = fs.existsSync(dist) ? fs.readdirSync(dist) : [];
          const picked = files.filter((f) => exts.some((e) => f.endsWith(e)));

          for (const f of picked) {
            const src = path.join(dist, f);
            const ext = path.extname(f);
            const dstName = 'NocLauncher-' + v + '-' + osTag + '-' + archTag + ext;
            const dst = path.join(out, dstName);
            fs.copyFileSync(src, dst);
          }

          const outFiles = fs.readdirSync(out).map((f) => path.join(out, f));
          const lines = [];
          for (const f of outFiles) {
            const buf = fs.readFileSync(f);
            const hash = crypto.createHash('sha256').update(buf).digest('hex');
            lines.push(hash + '  ' + path.basename(f));
          }
          fs.writeFileSync(path.join(out, 'SHA256SUMS-' + t + '.txt'), lines.join('\n') + '\n');
          NODE

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          files: dist/release-assets/*
          fail_on_unmatched_files: false
          generate_release_notes: true
          body: |
            ## üöÄ NocLauncher ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

            –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ NocLauncher.

            ### üì¶ Assets
            - Windows: `.exe`
            - Linux: `.AppImage`
            - macOS: `.dmg` / `.zip`

            ### üõ° Windows Defender / SmartScreen
            –ò–Ω–æ–≥–¥–∞ Windows –º–æ–∂–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ unsigned-—Å–±–æ—Ä–æ–∫.
            –û–±—ã—á–Ω–æ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏ –∏ –Ω–∏–∑–∫–æ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–µ–π –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞, –∞ –Ω–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º –∑–∞—Ä–∞–∂–µ–Ω–∏–µ–º.

            –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
            1) —Å–∫–∞—á–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ Releases,
            2) —Å–≤–µ—Ä—è—Ç—å SHA256,
            3) –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ñ–∞–π–ª –≤ VirusTotal.

            ### üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
            - –í —Ä–µ–ª–∏–∑–µ –µ—Å—Ç—å —Ñ–∞–π–ª—ã `SHA256SUMS-*.txt`

            ```powershell
            Get-FileHash .\NocLauncher-<version>-windows-x64.exe -Algorithm SHA256
            ```

            ### üìù Changelog
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∏–∂–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–º–∏—Ç–æ–≤ –∏ PR.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
